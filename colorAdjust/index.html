<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

</body>
<script type="module">
    import util from '../util.js';
    const vertexShader = `
    attribute vec4 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;
    uniform mat4 u_projection;
    void main () {
    gl_Position = u_projection * a_position * vec4(1.0, -1.0, 1.0, 1.0);
    v_texCoord = a_texCoord;
    }
    `;

    const fragShader = `
    #define PI 3.1415926
    precision highp float;
    varying vec2 v_texCoord;
    uniform sampler2D u_texture;
    uniform mat4 u_hue;
    uniform mat4 u_contrast;
    uniform mat4 u_saturate;
    uniform float u_temperature;
    uniform float u_tone;
    uniform mat4 u_rangeReduction;
    uniform mat4 u_matrix;
    void main () {

        vec4 color = texture2D(u_texture, v_texCoord);
        gl_FragColor = u_matrix * color;
    }
    `
    let width = 640;
    let height = 360;
    let canvas = document.createElement('canvas');
    let canvas2d = document.createElement('canvas');

    document.body.appendChild(canvas);
    document.body.appendChild(canvas2d);
    canvas.width = width;
    canvas.height = height;
    canvas2d.width = width;
    canvas2d.height = height;

    let context = canvas2d.getContext('2d');
    let gl = canvas.getContext('webgl');
    let pointsBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, pointsBuffer);
    let points = new Float32Array([
        0.0, 0.0,
        width, 0.0,
        width, height,
        width, height,
        0.0, height,
        0.0, 0.0
    ]);
    gl.bufferData(gl.ARRAY_BUFFER, points, gl.STATIC_DRAW);
    let texCoordPoints = new Float32Array([
        0.0, 0.0,
        1.0, 0.0,
        1.0, 1.0,
        1.0, 1.0,
        0.0, 1.0,
        0.0, 0.0
    ]);
    let texCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, texCoordPoints, gl.STATIC_DRAW);


    let program = util.initWebGL(gl, vertexShader, fragShader);
    gl.useProgram(program);
    let attribSetters = util.createAttributeSetters(gl, program);
    let uniformSetters = util.createUniformSetters(gl, program);
    let texture = util.createTexture(gl);

    let attributes = {
        a_position: {
            buffer: pointsBuffer,
            numComponents: 2,
        },
        a_texCoord: {
            buffer: texCoordBuffer,
            numComponents: 2,
        }
    }
    let colorMatrix = new Float32Array([0.05541720241308212, 0.34079352021217346, -0.5869410634040833, 0,
    -0.048134174197912216, 0.8745395541191101, 1.3783824443817139, 0, 0.9927169680595398, -0.21533308923244476,
    0.20855861902236938, 0, 0, 0, 0, 1]);

    let res = util.vecMultiMat([255, 0, 0, 255], colorMatrix);
    console.log(res);
    
    let uniforms = {
        u_projection: util.createProjection(width, height, 1),
        u_matrix: colorMatrix
    }

    let image = new Image();
    image.src = './50i.bmp';

    function draw() {
        
        util.setAttributes(attribSetters, attributes);
        util.setUniforms(uniformSetters, uniforms);
        gl.drawArrays(gl.TRIANGLES, 0, 6);


        context.drawImage(image, 0, 0, width, height);

        let imageData = context.getImageData(0, 0, width, height);
        // console.log(imageData);
        
        // let imageData = new ImageData(width, height);
        for (let i = 0; i < width * height * 4; i += 4) {
            // imageData.data[i] = 255;
            // imageData.data[i + 1] = 0;
            // imageData.data[i + 2] = 0;
            // imageData.data[i + 3] = 255;
            let vec = imageData.data.slice(i, i + 4);
            let res = util.vecMultiMat(vec, uniforms.u_matrix);
            imageData.data[i] = res[0];
            imageData.data[i + 1] = res[1];
            imageData.data[i + 2] = res[2];
            imageData.data[i + 3] = res[3];
        }
        context.putImageData(imageData, 0, 0);
    }

    image.onload = function () {
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
        draw();
    }


    let input = document.createElement('input');
    input.type = 'number';
    input.min = -180;
    input.max = 180;
    document.body.appendChild(input);
    input.onchange = function () {
        uniforms.u_matrix = util.createHueRotateMatrix(+input.value);
        draw();
    }


    
</script>

</html>