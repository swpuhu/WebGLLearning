let jove = {};
jove.fonts = [
    {
        "preferredFamily": "Adobe Caslon Pro",
        "fontFamily": "ACaslonPro-BoldItalic",
        "fontSubFamily": "Adobe Caslon Pro Bold",
        "fileName": "ACaslonPro-BoldItalic.otf",
        "winAscent": 1002,
        "winDescent": 700,
        "unitsPerEm": 1000,
        "ascent": 735,
        "descent": -265
    },
    {
        "preferredFamily": "Adobe Caslon Pro",
        "fontFamily": "ACaslonPro-Bold",
        "fontSubFamily": "Adobe Caslon Pro Bold",
        "fileName": "ACaslonPro-Bold.otf",
        "winAscent": 1002,
        "winDescent": 700,
        "unitsPerEm": 1000,
        "ascent": 735,
        "descent": -265
    },
    {
        "preferredFamily": "Adobe Caslon Pro",
        "fontFamily": "ACaslonPro-Italic",
        "fontSubFamily": "Adobe Caslon Pro",
        "fileName": "ACaslonPro-Italic.otf",
        "winAscent": 1002,
        "winDescent": 700,
        "unitsPerEm": 1000,
        "ascent": 735,
        "descent": -265
    },
    {
        "preferredFamily": "Adobe Caslon Pro",
        "fontFamily": "ACaslonPro-Regular",
        "fontSubFamily": "Adobe Caslon Pro",
        "fileName": "ACaslonPro-Regular.otf",
        "winAscent": 1002,
        "winDescent": 700,
        "unitsPerEm": 1000,
        "ascent": 735,
        "descent": -265
    },
    {
        "preferredFamily": "Adobe Caslon Pro",
        "fontFamily": "ACaslonPro-Semibold",
        "fontSubFamily": "Adobe Caslon Pro",
        "fileName": "ACaslonPro-Semibold.otf",
        "winAscent": 1002,
        "winDescent": 700,
        "unitsPerEm": 1000,
        "ascent": 735,
        "descent": -265
    },
    {
        "preferredFamily": "Agency FB",
        "fontFamily": "Agency FB",
        "fontSubFamily": "Agency FB",
        "fileName": "AGENCYR.TTF",
        "winAscent": 1889,
        "winDescent": 410,
        "unitsPerEm": 2048,
        "ascent": 2015,
        "descent": -410
    },
    {
        "preferredFamily": "Aharoni",
        "fontFamily": "Aharoni Bold",
        "fontSubFamily": "Aharoni",
        "fileName": "ahronbd.ttf",
        "winAscent": 1505,
        "winDescent": 518,
        "unitsPerEm": 2048,
        "ascent": 1505,
        "descent": -543
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial",
        "fontSubFamily": "Arial",
        "fileName": "arial.ttf",
        "winAscent": 1854,
        "winDescent": 434,
        "unitsPerEm": 2048,
        "ascent": 1854,
        "descent": -434
    },
    {
        "preferredFamily": "Adobe Caslon Pro",
        "fontFamily": "ACaslonPro-SemiboldItalic",
        "fontSubFamily": "Adobe Caslon Pro",
        "fileName": "ACaslonPro-SemiboldItalic.otf",
        "winAscent": 1002,
        "winDescent": 700,
        "unitsPerEm": 1000,
        "ascent": 735,
        "descent": -265
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Bold",
        "fontSubFamily": "Arial",
        "fileName": "arialbd.ttf",
        "winAscent": 1854,
        "winDescent": 434,
        "unitsPerEm": 2048,
        "ascent": 1854,
        "descent": -434
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Bold Italic",
        "fontSubFamily": "Arial",
        "fileName": "arialbi.ttf",
        "winAscent": 1854,
        "winDescent": 434,
        "unitsPerEm": 2048,
        "ascent": 1854,
        "descent": -434
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Narrow",
        "fontSubFamily": "Arial Narrow",
        "fileName": "ARIALN.TTF",
        "winAscent": 1888,
        "winDescent": 431,
        "unitsPerEm": 2048,
        "ascent": 1916,
        "descent": -434
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Narrow Bold",
        "fontSubFamily": "Arial Narrow",
        "fileName": "ARIALNB.TTF",
        "winAscent": 1910,
        "winDescent": 431,
        "unitsPerEm": 2048,
        "ascent": 1916,
        "descent": -434
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Black",
        "fontSubFamily": "Arial Black",
        "fileName": "ariblk.ttf",
        "winAscent": 2254,
        "winDescent": 634,
        "unitsPerEm": 2048,
        "ascent": 2254,
        "descent": -634
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Italic",
        "fontSubFamily": "Arial",
        "fileName": "ariali.ttf",
        "winAscent": 1854,
        "winDescent": 434,
        "unitsPerEm": 2048,
        "ascent": 1854,
        "descent": -434
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Narrow Bold Italic",
        "fontSubFamily": "Arial Narrow",
        "fileName": "ARIALNBI.TTF",
        "winAscent": 1916,
        "winDescent": 434,
        "unitsPerEm": 2048,
        "ascent": 1916,
        "descent": -434
    },
    {
        "preferredFamily": "Arial",
        "fontFamily": "Arial Narrow Italic",
        "fontSubFamily": "Arial Narrow",
        "fileName": "ARIALNI.TTF",
        "winAscent": 1873,
        "winDescent": 431,
        "unitsPerEm": 2048,
        "ascent": 1916,
        "descent": -434
    },
    {
        "preferredFamily": "Proxima Nova",
        "fontFamily": "ProximaNova-Light",
        "fontSubFamily": "Proxima Nova Lt",
        "fileName": "ProximaNovaLt.ttf",
        "winAscent": 790,
        "winDescent": 210,
        "unitsPerEm": 1000,
        "ascent": 790,
        "descent": -210
    },
    {
        "preferredFamily": "Sakkal Majalla",
        "fontFamily": "Sakkal Majalla Bold",
        "fontSubFamily": "Sakkal Majalla",
        "fileName": "majallab.ttf",
        "winAscent": 1810,
        "winDescent": 1050,
        "unitsPerEm": 2048,
        "ascent": 1810,
        "descent": -1050
    },
    {
        "preferredFamily": "Sakkal Majalla",
        "fontFamily": "Sakkal Majalla",
        "fontSubFamily": "Sakkal Majalla",
        "fileName": "majalla.ttf",
        "winAscent": 1810,
        "winDescent": 1050,
        "unitsPerEm": 2048,
        "ascent": 1810,
        "descent": -1050
    },
    {
        "preferredFamily": "Rosewood Std",
        "fontFamily": "RosewoodStd-Regular",
        "fontSubFamily": "Rosewood Std Regular",
        "fileName": "RosewoodStd-Regular.otf",
        "winAscent": 868,
        "winDescent": 302,
        "unitsPerEm": 1000,
        "ascent": 648,
        "descent": -352
    },
    {
        "preferredFamily": "Parchment",
        "fontFamily": "Parchment",
        "fontSubFamily": "Parchment",
        "fileName": "PARCHM.TTF",
        "winAscent": 1534,
        "winDescent": 651,
        "unitsPerEm": 2048,
        "ascent": 1536,
        "descent": -651
    },
    {
        "preferredFamily": "Showcard Gothic",
        "fontFamily": "Showcard Gothic",
        "fontSubFamily": "Showcard Gothic",
        "fileName": "SHOWG.TTF",
        "winAscent": 2119,
        "winDescent": 416,
        "unitsPerEm": 2048,
        "ascent": 1633,
        "descent": -415
    },
    {
        "preferredFamily": "Script MT Bold",
        "fontFamily": "Script MT Bold",
        "fontSubFamily": "Script MT Bold",
        "fileName": "SCRIPTBL.TTF",
        "winAscent": 1950,
        "winDescent": 516,
        "unitsPerEm": 2048,
        "ascent": 1950,
        "descent": -516
    },
    {
        "preferredFamily": "Microsoft YaHei",
        "fontFamily": "Microsoft YaHei Bold",
        "fontSubFamily": "Microsoft YaHei",
        "fileName": "msyhbd.ttf",
        "winAscent": 2167,
        "winDescent": 536,
        "unitsPerEm": 2048,
        "ascent": 1663,
        "descent": -536
    },
    {
        "preferredFamily": "Segoe UI Symbol",
        "fontFamily": "Segoe UI Symbol",
        "fontSubFamily": "Segoe UI Symbol",
        "fileName": "seguisym.ttf",
        "winAscent": 2210,
        "winDescent": 514,
        "unitsPerEm": 2048,
        "ascent": 2210,
        "descent": -514
    },
    {
        "preferredFamily": "SRG SSR Type",
        "fontFamily": "SRG SSR Type Bold",
        "fontSubFamily": "SRG SSR Type",
        "fileName": "SRGSSRType_Bd.ttf",
        "winAscent": 1015,
        "winDescent": 263,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "SRG SSR Type Serif",
        "fontFamily": "SRG SSR Type Serif",
        "fontSubFamily": "SRG SSR Type Serif",
        "fileName": "SRGSSRTypeSerif_Rg.ttf",
        "winAscent": 1019,
        "winDescent": 272,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "SimHei",
        "fontFamily": "SimHei",
        "fontSubFamily": "SimHei",
        "fileName": "SIMHEI.TTF",
        "winAscent": 220,
        "winDescent": 36,
        "unitsPerEm": 256,
        "ascent": 220,
        "descent": -36
    },
    {
        "preferredFamily": "KaiTi",
        "fontFamily": "KaiTi",
        "fontSubFamily": "KaiTi",
        "fileName": "SIMKAI.TTF",
        "winAscent": 220,
        "winDescent": 36,
        "unitsPerEm": 256,
        "ascent": 220,
        "descent": -36
    },
    {
        "preferredFamily": "SRG SSR Type Serif",
        "fontFamily": "SRG SSR Type Serif Light",
        "fontSubFamily": "SRG SSR Type Serif Light",
        "fileName": "SRGSSRTypeSerif_Lt.ttf",
        "winAscent": 1019,
        "winDescent": 272,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "Square721 BT",
        "fontFamily": "Square721 BT Roman",
        "fontSubFamily": "Square721 BT",
        "fileName": "Square.ttf",
        "winAscent": 2028,
        "winDescent": 483,
        "unitsPerEm": 2048,
        "ascent": 2028,
        "descent": -483
    },
    {
        "preferredFamily": "SRG SSR Type",
        "fontFamily": "SRG SSR Type Bold Italic",
        "fontSubFamily": "SRG SSR Type",
        "fileName": "SRGSSRType_BdIt.ttf",
        "winAscent": 1015,
        "winDescent": 263,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "SRG SSR Type Serif",
        "fontFamily": "SRG SSR Type Serif Medium",
        "fontSubFamily": "SRG SSR Type Serif Medium",
        "fileName": "SRGSSRTypeSerif_Md.ttf",
        "winAscent": 1019,
        "winDescent": 272,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "Microsoft YaHei",
        "fontFamily": "Microsoft YaHei",
        "fontSubFamily": "Microsoft YaHei",
        "fileName": "msyh.ttf",
        "winAscent": 2167,
        "winDescent": 536,
        "unitsPerEm": 2048,
        "ascent": 1663,
        "descent": -536
    },
    {
        "preferredFamily": "SRG SSR Type",
        "fontFamily": "SRG SSR Type Heavy",
        "fontSubFamily": "SRG SSR Type Heavy",
        "fileName": "SRGSSRType_He.ttf",
        "winAscent": 1015,
        "winDescent": 263,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "SRG SSR Type",
        "fontFamily": "SRG SSR Type Italic",
        "fontSubFamily": "SRG SSR Type",
        "fileName": "SRGSSRType_It.ttf",
        "winAscent": 1015,
        "winDescent": 263,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "SRG SSR Type",
        "fontFamily": "SRG SSR Type Medium",
        "fontSubFamily": "SRG SSR Type Medium",
        "fileName": "SRGSSRType_Md.ttf",
        "winAscent": 1015,
        "winDescent": 263,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "SRG SSR Type",
        "fontFamily": "SRG SSR Type Light",
        "fontSubFamily": "SRG SSR Type Light",
        "fileName": "SRGSSRType_Lt.ttf",
        "winAscent": 1015,
        "winDescent": 263,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "Vladimir Script",
        "fontFamily": "Vladimir Script",
        "fontSubFamily": "Vladimir Script",
        "fileName": "VLADIMIR.TTF",
        "winAscent": 1843,
        "winDescent": 639,
        "unitsPerEm": 2048,
        "ascent": 1843,
        "descent": -639
    },
    {
        "preferredFamily": "SRG SSR Type",
        "fontFamily": "SRG SSR Type",
        "fontSubFamily": "SRG SSR Type",
        "fileName": "SRGSSRType_Rg.ttf",
        "winAscent": 1015,
        "winDescent": 263,
        "unitsPerEm": 1000,
        "ascent": 963,
        "descent": -315
    },
    {
        "preferredFamily": "FangSong",
        "fontFamily": "FangSong",
        "fontSubFamily": "FangSong",
        "fileName": "SIMFANG.TTF",
        "winAscent": 220,
        "winDescent": 36,
        "unitsPerEm": 256,
        "ascent": 220,
        "descent": -36
    },
    {
        "preferredFamily": "Wingdings",
        "fontFamily": "Wingdings",
        "fontSubFamily": "Wingdings",
        "fileName": "wingding.ttf",
        "winAscent": 1841,
        "winDescent": 432,
        "unitsPerEm": 2048,
        "ascent": 1841,
        "descent": -432
    },
    {
        "preferredFamily": "Wingdings 3",
        "fontFamily": "Wingdings 3",
        "fontSubFamily": "Wingdings 3",
        "fileName": "WINGDNG3.TTF",
        "winAscent": 1900,
        "winDescent": 432,
        "unitsPerEm": 2048,
        "ascent": 1900,
        "descent": -432
    },
    {
        "preferredFamily": "Webdings",
        "fontFamily": "Webdings",
        "fontSubFamily": "Webdings",
        "fileName": "webdings.ttf",
        "winAscent": 1638,
        "winDescent": 410,
        "unitsPerEm": 2048,
        "ascent": 1638,
        "descent": -410
    },
    {
        "preferredFamily": "Wingdings 2",
        "fontFamily": "Wingdings 2",
        "fontSubFamily": "Wingdings 2",
        "fileName": "WINGDNG2.TTF",
        "winAscent": 1727,
        "winDescent": 432,
        "unitsPerEm": 2048,
        "ascent": 1727,
        "descent": -432
    },
    {
        "preferredFamily": "STCaiyun",
        "fontFamily": "STCaiyun",
        "fontSubFamily": "STCaiyun",
        "fileName": "STCAIYUN.TTF",
        "winAscent": 810,
        "winDescent": 226,
        "unitsPerEm": 1000,
        "ascent": 810,
        "descent": -226
    },
    {
        "preferredFamily": "Microsoft YaHei",
        "fontFamily": "Microsoft YaHei",
        "fontSubFamily": "Microsoft YaHei",
        "fileName": "",
        "ascent": 2167,
        "descent": 536,
        "winAscent": 1663,
        "winDescent": 519,
        "unitsPerEm": 2048
    }
]


let canvas = document.querySelector('#canvas');
// document.body.appendChild(canvas);
let context = canvas.getContext('2d');


function loadFont (fontFamily, url) {
    return new Promise((resolve, reject) => {
        if (fontFamily === 'Microsoft YaHei') {
            resolve();
            return;
        }
        let font = new FontFace(fontFamily, `url(${url})`);
        font.load().then(() => {
            document.fonts.add(font);
            resolve();
        }).catch(reject);
    })
}

function checkAndLoadFont (name, url = '') {
    return new Promise((resolve, reject) => {
        let values = document.fonts.values();
        let isHave = false;
        let item = values.next();
        while (!item.done && !isHave) {
            let fontFace = item.value;
            if (fontFace.family === name) {
                isHave = true;
                if (fontFace.status === 'loaded') {
                    resolve({ code: 0 });
                } else {
                    fontFace.loaded.then(resolve);
                    fontFace.load();
                }
            }
            item = values.next();
        }

        if (!isHave) {
            loadFont(name, url)
                .then(() => resolve({ code: 0 }))
                .catch(() => reject({ code: -1 }));
        }
    })
}

function isBlank (char) {
    return /\s/.test(char);
}

function isPunctuation (char) {
    return /[,\.";:]/.test(char);
}

function loadImage (src) {
    return new Promise((resolve) => {
        let image = new Image();
        image.onload = function () {
            resolve(image);
        }
        image.src = src;

    });
}

function draw (context, text, offsetX, offsetY, lineHeightPx, width) {
    let totalWidth = context.measureText(text).width;
    let lines = Math.ceil(totalWidth / width);
    let cursor = 0;
    let charNumsPerLine = Math.floor(text.length / lines);
    let currentLength = charNumsPerLine;
    let currentLine = 0;
    while (cursor + currentLength <= text.length) {
        currentLength = charNumsPerLine;
        let str = text.substr(cursor, currentLength);
        if (/\n/.test(str)) {
            let pos = str.indexOf('\n');
            if (pos > 0) {
                currentLength = pos;
                str = str.substr(0, pos);
            }
            currentLength = pos;
        }
        let strWidth = context.measureText(str).width;
        while (strWidth < width) {
            let nextChar = text[cursor + currentLength];
            if (/\n/.test(str) || cursor + currentLength >= text.length) break;
            ++currentLength;
            str = text.substr(cursor, currentLength);
            strWidth = context.measureText(str).width;
        }
        while (strWidth > width) {
            --currentLength;
            str = text.substr(cursor, currentLength);
            if (currentLength === 1) {
                break;
            }
            strWidth = context.measureText(str).width;
        }


        let nextChar = text[cursor + currentLength];
        if (isBlank(nextChar)) {
            ++cursor;
        } else if (isPunctuation(nextChar)) {
            let width = context.measureText(str + nextChar).width;
            if (width > width) {
                currentLength--;
            } else {
                currentLength++;
                str = str + nextChar;
            }
        }
        cursor += currentLength;
        let dY = currentLine * lineHeightPx + offsetY;
        context.fillText(str, offsetX, dY);
        ++currentLine;
    }
    str = text.substr(cursor, currentLength);
    let remainStr = str;
    let pos = remainStr.indexOf('\n');
    while (pos > 0) {
        let dY = currentLine * lineHeightPx + offsetY;
        str = remainStr.substr(0, pos);
        context.fillText(str, offsetX, dY);
        ++currentLine;
        remainStr = remainStr.substr(pos + 1);
        pos = remainStr.indexOf('\n');
    }
    let dY = currentLine * lineHeightPx + offsetY;
    context.fillText(remainStr, offsetX, dY);
}
window.drawText = function drawText (text, fontFamily = 'Microsoft YaHei', fontSize = 16, lineHeight = 0, fontStyle = 'normal', fontWeight = 'normal', textAlign = 'left', width = 100, height = 100, url) {
    checkAndLoadFont(fontFamily, url).then(async (e) => {
        if (e && e.code === 0) {
            canvas.width = width;
            canvas.height = height;
            context.clearRect(0, 0, width, height);
            context.font = `${fontStyle} ${fontWeight} ${fontSize}px ${fontFamily}`;
            context.textAlign = textAlign;
            context.textBaseline = 'top';

            let params = jove.fonts.find(item => item.fontFamily === fontFamily);
            let winAscent = params.winAscent;
            let winDescent = params.winDescent;
            let ascent = params.ascent;
            let descent = params.descent;
            let unitsPerEm = params.unitsPerEm;

            let coefficient = Math.round((winAscent + winDescent) / unitsPerEm * 100) / 100;
            let actuallyFontSize = Math.round(fontSize * coefficient);
            let lineHeightPx;
            if (!lineHeight) {
                lineHeightPx = actuallyFontSize;
            } else {
                lineHeightPx = Math.floor(fontSize * lineHeight);
            }

            let halfLineHeight = (lineHeightPx - actuallyFontSize) / 2;
            let diffWinAscent = (Math.round((winAscent - ascent) / unitsPerEm * fontSize));
            if (diffWinAscent < 0) {
                diffWinAscent = 0;
            }
            let offsetY = halfLineHeight + diffWinAscent;
            let offsetX = 0;
            if (textAlign === 'left') {
                offsetX = 0;
                context.direction = 'ltr';
            } else if (textAlign === 'center') {
                offsetX = width / 2;
                context.direction = 'ltr';
            } else {
                offsetX = width;
                context.direction = 'rtl';
            }
            draw(context, text, offsetX, offsetY, lineHeightPx, width);
            return await loadImage(canvas.toDataURL());
        }
    });
}